---
title: "Final Research: Testing Wegmans Myths"
author: "Matthew Fikes"
date: '2021-02-17'
output:
  pdf_document: default
  html_document: default
  word_document: default
---
\tableofcontents


## Problem

The problem being addressed in my research is to answer two hypotheses about how the Wegmans grocery chain chooses locations. 
The first hypothesis is that Wegmans has a gentleman's agreement with another chain in the area called Price Chopper. A 2006 article checked with a spokesman, who discredited the story and said that they in fact compete in Western New York and Pennsylvania (Wegmans & Price chopper, 2008). Another article from February 2021 talks again about hesitation in expanding into the Capital region of New York and the gentleman's agreement is also mentioned (Springer, 2021). It seems that the myth persists to this day. I will use locations of both stores to see if there are any insights into the gentleman's agreement area the chains are splitting. 
The second hypothesis is that Wegmans will only open a store if the area is wealthy or populated enough to serve it. This would make sense from the standpoint of sales, as there need to be enough people shopping to support the cost associated with running a store. Census information should provide light for this hypothesis.

Methods

To test the first hypothesis, I needed to look at locations of Wegmans and Price Chopper on a map. To do this I used the ggmap library to plot latitude and longitude retrieved during the data collection, sorted by store as a color feature. Locations and lines are plotted over a watercolor landscape map with boundaries generated by a boundary box function given the location data.
I also plotted beeswarm and box plots of minimum distance to nearest competitor by store. This was compiled by checking each store in turn against a list of competitor stores, measuring the Haversine distance between the latitudes and longitudes. The minimum distances in meters was written to a data frame and plotted. in kilometers. The minimum distance is 418.6m, mean minimum distance is 134.4km and maximum distance of 657.3km.

The initial map plot indicated only a few stores shared close proximity. Only six were within 1km of a rival, with 18 within 5km. To finish the hypothesis test I performed a cluster analysis on the location data. I used the leaderCluster library to create clusters that would accept latitude and longitude, calculate using Haversine distance, and only require a radius as input. The results confirmed that the stores are not competing in nearby areas. Only five clusters with a radius of 25km contained more than one kind of store. When looking at a map, it is evident that the Price Chopper stores are focused around the Albany/Schenectady area, which is the founding location of Price Chopper. I plotted a circle with a radius of approximately 140km and it covers nearly all their stores, with only a few Wegmans encroaching along the perimeter. All the mixed clusters touch the plotted circle.

For the second hypothesis, I will need to look at some economic data. To measure the features of the area, I used data from the American Community Survey run by the Census Bureau. Measures I tested include total population, mean household income, mean household value, and total households. All of these values are within the Census block containing the stores. I took each variable and created a density plot. I tried to plot the same data with a log transformation to see if it would be more normal. 
I also plotted density figures for income by each income range, again with standard and log transformed data. There was more benefit to the log transformation on income range data. in normalizing the distribution.

Findings

Based on the results of plotting store locations it seems there is a well-defined territory for the main competitor to Wegmans. Despite company insistence of no existing gentleman's agreement on territory sharing, there is very little intermingling of stores. Anecdotal stories of an agreement from Wegmans not to expand further North or East seems to be supported by the data. Whether or not a location falls within the plotted radius around Schenectady should be a good predictor of a Wegmans entering the market. 
The distributions show that both stores are located in areas with both high and low incomes, although Wegmans can be found in areas with higher population and higher incomes. At the highest income bins this is the most noticeable. Economic factors appear to play a smaller part in location selection than hypothesized.


Limitations
The first hypothesis data did not include when stores were founded. Analyzing the spread of the stores over time would provide additional information to the interaction between chains. The data might help explain the few stores that are in close proximity. They may have been founded prior to any agreement or obtained in a merger. There is existing documentation of Price Chopper acquiring stores from other chains (Price Chopper Supermarkets, 2021).
The second hypothesis analysis only looked at economic and not social factors. Comparison areas were based on Census blocks and stores could potentially support additional areas outside of that block that were not taken into account. Future research could add other variables like ethnicity to see if there is any bias in their service area.

References:

Wegmans & Price chopper: The real deal. (2008, April 2). Retrieved March 02, 2021, from http://alloveralbany.com/archive/2008/04/02/wegmans-price-chopper-the-real-deal

Springer, J. (2021, February 12). Wegmans to ALBANY: Not now. Retrieved March 02, 2021, from https://www.winsightgrocerybusiness.com/retailers/wegmans-albany-not-now

Price Chopper Supermarkets. (2021, February 10). Retrieved March 02, 2021, from https://en.wikipedia.org/wiki/Price_Chopper_Supermarkets

```{r include=FALSE, warning=FALSE}
library(ggplot2)
library(ggmap)
library(geosphere)
library(ggbeeswarm)
library(ggpubr)
library(reshape2)
library(dplyr)
library(leaderCluster)
library(factoextra)

# load in data files, separated by store and including store and data from ACS surveys
pchop_df <- read.csv('C:/Users/mfikes/Desktop/Bellevue/DSC520/Final Project/geocode_PC.csv')
weg_df <- read.csv('C:/Users/mfikes/Desktop/Bellevue/DSC520/Final Project/geocode_Wegmans.csv')

# label stores
pchop_df$store = 'Price Chopper'
weg_df$store = 'Wegmans'

# make smaller combined dataframe just for location info
locvars <- c('store','Latitude','Longitude')
location_df <- rbind(pchop_df[locvars],weg_df[locvars])

# make full combined dataframe
combined_df <- rbind(pchop_df,weg_df)

```


```{r echo=FALSE}
# rename and manage long column names
names(combined_df)[names(combined_df) == "ACS.Demographics.Population.by.age.range.Total.Value"] <- "TotalPop"
names(combined_df)[names(combined_df) == "ACS.Economics.Median.household.income.Total.Value"] <- "MedianIncome"
names(combined_df)[names(combined_df) == "ACS.Economics.Number.of.households.Total.Value"] <- "TotalHouseholds"
names(combined_df)[names(combined_df) == "ACS.Housing.Median.value.of.owner.occupied.housing.units.Total.Value"] <- "MedianHouseValue"
names(combined_df)[names(combined_df) == "ACS.Demographics.Race.and.ethnicity.Hispanic.or.Latino.Percentage"] <- "HispPct"
names(combined_df)[names(combined_df) == "ACS.Demographics.Race.and.ethnicity.Not.Hispanic.or.Latino.Percentage"] <- "NonHispPct"

# group together economic data
IncomeFields <- c('store','ACS.Economics.Household.income.Less.than..10.000.Value',
'ACS.Economics.Household.income..10.000.to..14.999.Value',
'ACS.Economics.Household.income..15.000.to..19.999.Value',
'ACS.Economics.Household.income..20.000.to..24.999.Value',
'ACS.Economics.Household.income..25.000.to..29.999.Value',
'ACS.Economics.Household.income..30.000.to..34.999.Value',
'ACS.Economics.Household.income..35.000.to..39.999.Value',
'ACS.Economics.Household.income..40.000.to..44.999.Value',
'ACS.Economics.Household.income..45.000.to..49.999.Value',
'ACS.Economics.Household.income..50.000.to..59.999.Value',
'ACS.Economics.Household.income..60.000.to..74.999.Value',
'ACS.Economics.Household.income..75.000.to..99.999.Value',
'ACS.Economics.Household.income..100.000.to..124.999.Value',
'ACS.Economics.Household.income..125.000.to..149.999.Value',
'ACS.Economics.Household.income..150.000.to..199.999.Value',
'ACS.Economics.Household.income..200.000.or.more.Value'
)

# group non-hispanic ethnicity fields
NonHispFields <- c('store','ACS.Demographics.Race.and.ethnicity.Not.Hispanic.or.Latino.Percentage',
'ACS.Demographics.Race.and.ethnicity.Not.Hispanic.or.Latino:.White.alone.Percentage',
'ACS.Demographics.Race.and.ethnicity.Not.Hispanic.or.Latino:.Black.or.African.American.alone.Percentage',
'ACS.Demographics.Race.and.ethnicity.Not.Hispanic.or.Latino:.American.Indian.and.Alaska.Native.alone.Percentage',
'ACS.Demographics.Race.and.ethnicity.Not.Hispanic.or.Latino:.Asian.alone.Percentage',
'ACS.Demographics.Race.and.ethnicity.Not.Hispanic.or.Latino:.Native.Hawaiian.and.Other.Pacific.Islander.alone.Percentage',
'ACS.Demographics.Race.and.ethnicity.Not.Hispanic.or.Latino:.Some.other.race.alone.Percentage',
'ACS.Demographics.Race.and.ethnicity.Not.Hispanic.or.Latino:.Two.or.more.races.Percentage',
'ACS.Demographics.Race.and.ethnicity.Not.Hispanic.or.Latino:.Two.or.more.races:.Two.races.including.Some.other.race.Percentage',
'ACS.Demographics.Race.and.ethnicity.Not.Hispanic.or.Latino:.Two.or.more.races:.Two.races.excluding.Some.other.race..and.three.or.more.races.Percentage'
)

# group hispanic ethnicity fields
HispFields <- c('store','ACS.Demographics.Race.and.ethnicity.Hispanic.or.Latino:.White.alone.Percentage',
'ACS.Demographics.Race.and.ethnicity.Hispanic.or.Latino:.Black.or.African.American.alone.Percentage',
'ACS.Demographics.Race.and.ethnicity.Hispanic.or.Latino:.American.Indian.and.Alaska.Native.alone.Percentage',
'ACS.Demographics.Race.and.ethnicity.Hispanic.or.Latino:.Asian.alone.Percentage',
'ACS.Demographics.Race.and.ethnicity.Hispanic.or.Latino:.Native.Hawaiian.and.Other.Pacific.Islander.alone.Percentage',
'ACS.Demographics.Race.and.ethnicity.Hispanic.or.Latino:.Some.other.race.alone.Percentage',
'ACS.Demographics.Race.and.ethnicity.Hispanic.or.Latino:.Two.or.more.races.Percentage',
'ACS.Demographics.Race.and.ethnicity.Hispanic.or.Latino:.Two.or.more.races:.Two.races.including.Some.other.race.Percentage',
'ACS.Demographics.Race.and.ethnicity.Hispanic.or.Latino:.Two.or.more.races:.Two.races.excluding.Some.other.race..and.three.or.more.races.Percentage'
)


```


```{r echo=FALSE}
# find nearest competitor
for (rows in 1:nrow(location_df)){
    
 
  curr_loc = c(location_df$Longitude[rows],location_df$Latitude[rows])
  loclist <- NULL
  if(location_df$store[rows] == 'Wegmans'){
      datacomp <- subset(location_df, store =='Price Chopper')
    } else {
      datacomp <- subset(location_df, store =='Wegmans')
      
    }
  
  for (i in 1:nrow(datacomp)){
    comp_loc = c(datacomp$Longitude[i],datacomp$Latitude[i])
    distance = distHaversine(curr_loc,comp_loc,r=6378137)
    loclist = rbind(loclist, data.frame(distance))
    
  }
  
  location_df$closest_comp[rows] <-min(loclist)
}


```
## Competitor minimum distance plots
```{r echo=FALSE, fig.width=10, fig.height=6}
boxplot((closest_comp / 1000)~store,data=location_df, main="Minimum Distance to Competitors",
   ylab="Distance (km)")

ggplot(data=location_df,aes(y=((closest_comp/1000)),x=store)) + geom_beeswarm(aes(color=store),alpha=0.5,cex=1.5, show.legend=FALSE) + ylab("Distance (km)") + coord_flip() + ggtitle("Distance to Nearest Competitor Store") 

```

\newpage

## 20 Closest stores, distance in meters
```{r echo=FALSE}
summary(location_df$closest_comp)
closest10 <-slice_min(location_df,order_by=closest_comp,n=20)
closest10
```
## Plot of store locations
```{r out.width="100%", echo=FALSE, fig.width=10, fig.height=14, message=FALSE}
mapbox <- make_bbox(Longitude,Latitude,data=combined_df, f=0.05)
plotmap <- get_stamenmap(mapbox, zoom=7, maptype='watercolor')
labelmap <- get_stamenmap(mapbox, zoom=7, maptype='toner-labels')
linemap <- get_stamenmap(mapbox, zoom=7, maptype='toner-lines')


locationmap <- ggmap(plotmap, darken = c(0.6, "white")) + geom_point(data=location_df, size=2, alpha=0.5,aes(x=Longitude,y=Latitude,color=store)) + inset_ggmap(labelmap) + scale_color_manual(values=c('red','#1a3cea'))

locationmap
#ggsave("locationmap.jpg")
```

## Plotted clusters, 25km radius

```{r out.width="100%", echo=FALSE, fig.width=10, fig.height=14, message=FALSE}

geo_clusters <- leaderCluster(data.frame(location_df[,2:3]), radius = 25, distance= 'haversine')
cluster_coords <- data.frame(Long=geo_clusters[[2]][,2],Lat=geo_clusters[[2]][,1])
locationmap + geom_point(data=cluster_coords, aes(x=Long,y=Lat),color='black',alpha=0.1,size=17) 

```
\newpage

## Clusters containing both stores
```{r echo = FALSE}
# look for mixed clusters
location_df$cluster <- geo_clusters$cluster_id
cluster_list <- unique(location_df$cluster)
for (i in cluster_list){
  cluster_store = subset(location_df, cluster == i, select = store)
  if (nrow(cluster_store)>1){
    if (length(unique(cluster_store$store))>1){
      print(cluster_store$store)
      print(i)
    }
   
  }
}
```
\newpage

## Clusters with 140km radius overplot centered on Schenectady NY
```{r out.width="100%", echo=FALSE, fig.width=10, fig.height=14, message=FALSE}
locationmap + geom_point(data=cluster_coords, aes(x=Long,y=Lat),color='black',alpha=0.1,size=17)+geom_point(aes(y=42.818280,x=-73.940827),size=140, alpha = 0.02)
```

## Density plots of variables
```{r echo=FALSE, fig.width=15, fig.height=14, results=FALSE, message=FALSE, warning=FALSE}

PopHist <-ggplot(data=combined_df, aes(x=TotalPop,fill=store)) + geom_histogram(alpha=0.4,position='identity',stat='density') + ggtitle("Total Population in Store Census Area")


IncHist <-ggplot(data=combined_df, aes(MedianIncome,fill=store)) + geom_histogram(alpha=0.3,position='identity',stat='density') + ggtitle("Median Income in Store Census Area") 


HouseholdHist <-ggplot(data=combined_df, aes(TotalHouseholds,fill=store)) + geom_histogram(alpha=0.3,position='identity',stat='density') + ggtitle("Total Households in Store Census Area")


HomeValHist <-ggplot(data=combined_df, aes(MedianHouseValue,fill=store)) + geom_histogram(alpha=0.3,position='identity',stat='density') + ggtitle("Median Home Value in Store Census Area")


ggarrange(PopHist, IncHist, HouseholdHist, HomeValHist, nrow = 2, ncol=2,common.legend=TRUE, legend='top')

```

\newpage

## Density plots of variables, x-axis log10 transformed
```{r echo=FALSE, fig.width=15, fig.height=14, results=FALSE, message=FALSE, warning=FALSE}

logPopHist <-ggplot(data=combined_df, aes(TotalPop,fill=store)) + geom_histogram(alpha=0.4,position='identity',stat='density') + ggtitle("log Total Population in Store Census Area")+scale_x_continuous(trans = "log10")


logIncHist <-ggplot(data=combined_df, aes(MedianIncome,fill=store)) + geom_histogram(alpha=0.3,position='identity',stat='density') + ggtitle("log Median Income in Store Census Area") +scale_x_continuous(trans = "log10")


logHouseholdHist <-ggplot(data=combined_df, aes(TotalHouseholds,fill=store)) + geom_histogram(alpha=0.3,position='identity',stat='density') + ggtitle("log Total Households in Store Census Area")+scale_x_continuous(trans = "log10")


logHomeValHist <-ggplot(data=combined_df, aes(MedianHouseValue,fill=store)) + geom_histogram(alpha=0.3,position='identity',stat='density') + ggtitle("log Median Home Value in Store Census Area")+scale_x_continuous(trans = "log10")


ggarrange(logPopHist, logIncHist, logHouseholdHist, logHomeValHist, nrow = 2, ncol=2,common.legend=TRUE, legend='top')

```

\newpage


## Density plots by income range
```{r echo=FALSE, fig.width=16, fig.height=18, message=FALSE, warning=FALSE, out.width="100%"}
Store_Inc <- subset(combined_df, select = IncomeFields)
Income_melt <- melt(Store_Inc)
Income_melt[Income_melt == 0] <- NA

income_labels = c('<$10K','$10K-$14,999','$15K-$19,999','$20K-$24,999','$25K-$29,999','$30K-$34,999','$35K-$39,999','$40K-$44,999','$45K-$49,999','$50K-$59,999','$60K-$74,999','$75K-$99,999','$100K-$124,999','$125K-$149,999','$150K-$199,999','$200K+')

plot_relabel <- function(variable,value){
  return(income_labels[value])
}

ggplot(Income_melt,aes(x=value,fill= store)) +
  geom_histogram(alpha=0.3,position='identity',stat='density') +
  xlab('location')+
  facet_wrap(variable~., labeller=plot_relabel,scales='free_y',ncol=2) +
  ggtitle("Count of Households in Store Census Areas by Household Income")

```
\newpage

## Density plots by income range, x-axis log10 transform
```{r echo=FALSE, fig.width=16, fig.height=18, message=FALSE, warning=FALSE, out.width="100%"}
Store_Inc <- subset(combined_df, select = IncomeFields)
Income_melt <- melt(Store_Inc)
Income_melt[Income_melt == 0] <- NA

income_labels = c('<$10K','$10K-$14,999','$15K-$19,999','$20K-$24,999','$25K-$29,999','$30K-$34,999','$35K-$39,999','$40K-$44,999','$45K-$49,999','$50K-$59,999','$60K-$74,999','$75K-$99,999','$100K-$124,999','$125K-$149,999','$150K-$199,999','$200K+')

plot_relabel <- function(variable,value){
  return(income_labels[value])
}


ggplot(Income_melt,aes(x=value,fill= store)) +
  geom_histogram(alpha=0.3,position='identity',stat='density') +
  xlab('location')+
  facet_wrap(variable~., labeller=plot_relabel,scales='free_y',ncol=2) +
  ggtitle("Count of Households in Store Census Areas by Household Income")+scale_x_continuous(trans = "log10")

```